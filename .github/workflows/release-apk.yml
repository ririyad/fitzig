name: Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release-apk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate EXPO_TOKEN
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "::error::Missing EXPO_TOKEN. Add it in GitHub repository secrets."
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo and EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: 16.0.0
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build Android APK
        id: eas_build
        run: |
          set -euo pipefail
          eas build --platform android --profile release --non-interactive --wait --json > eas-build.json
          node <<'NODE'
          const fs = require('fs');
          const raw = fs.readFileSync('eas-build.json', 'utf8').trim();
          const parsed = JSON.parse(raw);
          const build = Array.isArray(parsed) ? parsed[0] : parsed;

          const apkUrl =
            build?.artifacts?.applicationArchiveUrl ||
            build?.artifacts?.buildUrl ||
            build?.artifactUrl ||
            null;

          if (!apkUrl) {
            console.error('Could not find APK URL in EAS build output.');
            process.exit(1);
          }

          const out = process.env.GITHUB_OUTPUT;
          fs.appendFileSync(out, `apk_url=${apkUrl}\n`);
          if (build?.id) {
            fs.appendFileSync(out, `build_id=${build.id}\n`);
          }
          NODE

      - name: Prepare release metadata
        id: meta
        run: |
          set -euo pipefail
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            TAG="${GITHUB_REF_NAME}"
            RELEASE_NAME="Fitzig ${TAG}"
            PRERELEASE="false"
          else
            SHORT_SHA="${GITHUB_SHA::7}"
            TAG="manual-${SHORT_SHA}"
            RELEASE_NAME="Fitzig manual ${SHORT_SHA}"
            PRERELEASE="true"
          fi

          APK_NAME="fitzig-${TAG}.apk"

          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "release_name=${RELEASE_NAME}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"
          echo "apk_name=${APK_NAME}" >> "$GITHUB_OUTPUT"

      - name: Download APK artifact
        run: |
          set -euo pipefail
          curl -fL "${{ steps.eas_build.outputs.apk_url }}" -o "${{ steps.meta.outputs.apk_name }}"
          ls -lh "${{ steps.meta.outputs.apk_name }}"

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: ${{ steps.meta.outputs.release_name }}
          prerelease: ${{ steps.meta.outputs.prerelease }}
          generate_release_notes: true
          files: ${{ steps.meta.outputs.apk_name }}
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
